<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Tram-Abfahrten</title>
  <link rel="stylesheet" href="led.css">
  <!-- Font Awesome CDN for bus icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .headline {
      font-family: sans-serif;
      font-size: 2em;
      font-weight: 400;
      margin: 0;
    }
    .headline-refresh {
      font-size: 1.3em;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 0.5em;">
      <h1 class="headline">Nächste 10 Tram-Abfahrten</h1>
      <i id="refresh-icon" class="fa-solid fa-arrows-rotate headline-refresh" style="cursor: pointer;"></i>
    </div>
    <div id="clock" style="font-size: 1.2em; font-family: monospace;"></div>
  </div>
  <table id="departures">
    <thead>
      <tr>
        <th>Linie</th>
        <th>Richtung</th>
        <th class="verspaetung">Verspätung</th>
        <th>Abfahrt (live)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    async function loadDepartures() {
      const refreshIcon = document.getElementById('refresh-icon');
      if (refreshIcon) {
        refreshIcon.classList.add('rotate-refresh');
        setTimeout(() => refreshIcon.classList.remove('rotate-refresh'), 1000);
      }
      const refreshIconBus = document.getElementById('refresh-icon-bus');
      if (refreshIconBus) {
        refreshIconBus.classList.add('rotate-refresh');
        setTimeout(() => refreshIconBus.classList.remove('rotate-refresh'), 1000);
      }
      const res = await fetch('/api/abfahrten');
      const data = await res.json();
      // Trams
      const tramTbody = document.querySelector('#departures tbody');
      tramTbody.innerHTML = '';
      // Zeige die nächsten 10 zukünftigen Abfahrten aus den ersten 15 gelieferten
      const now = new Date();
      const futureTrams = data.trams
        .filter(dep => dep.abfahrt_live && Math.round((new Date(dep.abfahrt_live) - now) / 60000) >= 0)
        .slice(0, 10);
      futureTrams.forEach(dep => {
        const live = new Date(dep.abfahrt_live);
        const diffMin = Math.round((live - now) / 60000);
        const tr = document.createElement('tr');
        let delayCell = '';
        if (dep.abfahrt_geplant) {
          const planned = new Date(dep.abfahrt_geplant);
          if (live > planned) {
            delayCell = '<td class="verspaetung">&gt;</td>';
          } else {
            delayCell = '<td class="verspaetung"></td>';
          }
        } else {
          delayCell = '<td class="verspaetung"></td>';
        }
        let abfahrtLiveCell = '<td>-</td>';
        if (diffMin === 0) {
          abfahrtLiveCell = `<td><i class='fa-solid fa-bus-simple'></i></td>`;
        } else if (diffMin > 0) {
          abfahrtLiveCell = `<td class='minutenanzeige'>${diffMin}'</td>`;
        }
        tr.innerHTML = `
          <td>${dep.linie}</td>
          <td>${dep.richtung}</td>
          ${delayCell}
          ${abfahrtLiveCell}
        `;
        tramTbody.appendChild(tr);
      });

      // Busse
      let busTable = document.getElementById('bus-departures');
      if (!busTable) {
        const busTitleWrap = document.createElement('div');
        busTitleWrap.style.display = 'flex';
        busTitleWrap.style.alignItems = 'center';
        busTitleWrap.style.gap = '0.5em';
        busTitleWrap.style.marginTop = '2em';
        const busTitle = document.createElement('h1');
        busTitle.textContent = 'Nächste 10 Bus-Abfahrten';
        busTitle.className = 'headline';
        const busRefreshIcon = document.createElement('i');
        busRefreshIcon.className = 'fa-solid fa-arrows-rotate headline-refresh';
        busRefreshIcon.id = 'refresh-icon-bus';
        busRefreshIcon.style.cursor = 'pointer';
        busTitleWrap.appendChild(busTitle);
        busTitleWrap.appendChild(busRefreshIcon);
        document.body.appendChild(busTitleWrap);
        busTable = document.createElement('table');
        busTable.id = 'bus-departures';
        busTable.innerHTML = `
          <thead>
            <tr>
              <th>Linie</th>
              <th>Richtung</th>
              <th class="verspaetung">Verspätung</th>
              <th>Abfahrt (live)</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        document.body.appendChild(busTable);
      }
      const busTbody = busTable.querySelector('tbody');
      busTbody.innerHTML = '';
      // Zeige die nächsten 10 zukünftigen Bus-Abfahrten aus den ersten 15 gelieferten
      const futureBuses = data.buses
        .filter(dep => dep.abfahrt_live && Math.round((new Date(dep.abfahrt_live) - now) / 60000) >= 0)
        .slice(0, 10);
      futureBuses.forEach(dep => {
        const live = new Date(dep.abfahrt_live);
        const diffMin = Math.round((live - now) / 60000);
        const tr = document.createElement('tr');
        let delayCell = '';
        if (dep.abfahrt_geplant) {
          const planned = new Date(dep.abfahrt_geplant);
          if (live > planned) {
            delayCell = '<td class="verspaetung">&gt;</td>';
          } else {
            delayCell = '<td class="verspaetung"></td>';
          }
        } else {
          delayCell = '<td class="verspaetung"></td>';
        }
        let abfahrtLiveCell = '<td>-</td>';
        if (diffMin === 0) {
          abfahrtLiveCell = `<td><i class='fa-solid fa-bus-simple'></i></td>`;
        } else if (diffMin > 0) {
          abfahrtLiveCell = `<td class='minutenanzeige'>${diffMin}'</td>`;
        }
        tr.innerHTML = `
          <td>${dep.linie}</td>
          <td>${dep.richtung}</td>
          ${delayCell}
          ${abfahrtLiveCell}
        `;
        busTbody.appendChild(tr);
      });
    }
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString();
    }
    loadDepartures();
  setInterval(loadDepartures, 15 * 1000); // alle 15 Sekunden aktualisieren
    updateClock();
    setInterval(updateClock, 1000); // Uhr jede Sekunde aktualisieren
  </script>
</body>
</html>
