<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Tram-Abfahrten</title>
  <style>
    body { font-family: sans-serif; background: #222; color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; }
    th, td { padding: 0.5em 1em; border: 1px solid #444; text-align: left; }
    th { background: #333; }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center;">
  <h1>N채chste 10 Tram-Abfahrten</h1>
    <div id="clock" style="font-size: 1.2em; font-family: monospace;"></div>
  </div>
  <table id="departures">
    <thead>
      <tr>
        <th>Linie</th>
        <th>Richtung</th>
        <th>Name</th>
        <th>Abfahrt (geplant)</th>
        <th>Abfahrt (live)</th>
        <th>Versp채tung</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    async function loadDepartures() {
      const res = await fetch('/api/abfahrten');
      const data = await res.json();
      // Trams
      const tramTbody = document.querySelector('#departures tbody');
      tramTbody.innerHTML = '';
      data.trams.forEach(dep => {
        const tr = document.createElement('tr');
        let delayCell = '';
        if (dep.abfahrt_live && dep.abfahrt_geplant) {
          const planned = new Date(dep.abfahrt_geplant);
          const live = new Date(dep.abfahrt_live);
          const diffMin = Math.round((live - planned) / 60000);
          if (diffMin > 0) {
            delayCell = `<td>+${diffMin}</td>`;
          } else if (diffMin < 0) {
            delayCell = `<td>${diffMin}</td>`;
          } else {
            delayCell = '<td>on time</td>';
          }
        } else {
          delayCell = '<td>on time</td>';
        }
        tr.innerHTML = `
          <td>${dep.linie}</td>
          <td>${dep.richtung}</td>
          <td>${dep.name || '-'}</td>
          <td>${dep.abfahrt_geplant ? new Date(dep.abfahrt_geplant).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '-'}</td>
          <td>${dep.abfahrt_live ? new Date(dep.abfahrt_live).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '-'}</td>
          ${delayCell}
        `;
        tramTbody.appendChild(tr);
      });

      // Busse
      let busTable = document.getElementById('bus-departures');
      if (!busTable) {
        const busTitle = document.createElement('h2');
        busTitle.textContent = 'N채chste 10 Bus-Abfahrten';
        busTitle.style.marginTop = '2em';
        document.body.appendChild(busTitle);
        busTable = document.createElement('table');
        busTable.id = 'bus-departures';
        busTable.innerHTML = `
          <thead>
            <tr>
              <th>Linie</th>
              <th>Richtung</th>
              <th>Name</th>
              <th>Abfahrt (geplant)</th>
              <th>Abfahrt (live)</th>
              <th>Versp채tung</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        document.body.appendChild(busTable);
      }
      const busTbody = busTable.querySelector('tbody');
      busTbody.innerHTML = '';
      data.buses.forEach(dep => {
        const tr = document.createElement('tr');
        let delayCell = '';
        if (dep.abfahrt_live && dep.abfahrt_geplant) {
          const planned = new Date(dep.abfahrt_geplant);
          const live = new Date(dep.abfahrt_live);
          const diffMin = Math.round((live - planned) / 60000);
          if (diffMin > 0) {
            delayCell = `<td>+${diffMin}</td>`;
          } else if (diffMin < 0) {
            delayCell = `<td>${diffMin}</td>`;
          } else {
            delayCell = '<td>on time</td>';
          }
        } else {
          delayCell = '<td>on time</td>';
        }
        tr.innerHTML = `
          <td>${dep.linie}</td>
          <td>${dep.richtung}</td>
          <td>${dep.name || '-'}</td>
          <td>${dep.abfahrt_geplant ? new Date(dep.abfahrt_geplant).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '-'}</td>
          <td>${dep.abfahrt_live ? new Date(dep.abfahrt_live).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '-'}</td>
          ${delayCell}
        `;
        busTbody.appendChild(tr);
      });
    }
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString();
    }
    loadDepartures();
    setInterval(loadDepartures, 30 * 1000); // alle 30 Sekunden aktualisieren
    updateClock();
    setInterval(updateClock, 1000); // Uhr jede Sekunde aktualisieren
  </script>
</body>
</html>